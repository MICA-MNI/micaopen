# Histological analysis workflow

This workflow decribes processing steps necessary to map variations in the regional cytoarchitecture of the amygdala.

## Prerequisites

- BigBrain volume (100 micron; Amunts et al., 2013) and subcortical segmentations (Xiao et al. 2019)
- Juelich probability maps (Amunts et al. 2020)
- Required software: Python v3.7, ITK-snap v3.8

## Steps

### Isolate and pre-process volumetric amygdala data from BigBrain

1. **Crop amygdala volumes**: Crop amygdala region from full BigBrain volume, independently for each hemisphere;
2. **Resampling**: Resample mask to resolution of cropped volumes;
3. **Binarize mask**: Binarize the amygdala mask.

### Generate radiomics features

4. **Feature extraction**: Radiomics features of the amygdala can be generated for all moments and kernel sizes.

- **Input:** 
  - Amygdala mask
  - BigBrain volume
- **Output:** 
  - Feature bank (n=20, 4 moments x 5 kernel sizes)
 
**Script:** `3.test_radiomics.ipynb`

### Clean radiomics features for post-processing

5. **Clean radiomic feature outputs**: After generating features with pyradiomics, some feature outputs may have different sizes relative to the orginal input volume (due to padding). All volumes should be cropped to a consistent size.
6. **Create feature bank matrix**: Put all features into a PANDAS dataframe of all the moments (feature bank).

- **Input:** 
  - Feature volumes
- **Output:** 
  - .csv file of feature bank

**Script:** `5.crop_featurebank.ipynb`

### Retrieve and process Juelich probability maps of the amygdala

Note: probability maps are openly available on the ebrains repository: https://www.ebrains.eu/ 

7. **Registration**: Register probability maps to BigBrain histological space.
8. **Thresholding**: Apply thresholding (retain only top 5% of values) to the Juelich probability maps.

### Generate UMAP projections

- **Input:** 
  - Amygdala mask
  - Amygdala BigBrain volume
  - Feature bank
- **Output:** 
  - UMAP embeddings of feature bank
  - Juelich probability maps
  
**Script:** `9.Umap_.ipynb`

### Validate UMAP Projections

Statify UMAP projections with thresholded Juelich probability maps.

- **Input:** 
  - Amygdala mask
  - UMAP embeddings
  - Juelich probability maps

**Script:** `10.UMAP_heatmap.ipynb`

### Compute UMAP color spectrum

Apply color spectrum map over all the data points in UMAP projection.

- **Input:** 
  - Amygdala mask
  - UMAP embeddings
- **Output:** 
  - UMAP color spectrum embeddings

**Script:** `11.Umap_2Dclrbar.ipynb`

### Variogram matching test

Apply variogram matching test to account for spatial autocorrelation in correlating U1 and U2 with all three coordinate axes.

- **Input:** 
  - Amygdala Mask
  - UMAP embeddings
- **Output:** 
  - Histogram and p-values of variogram null model

**Script:** `12.Variograms.ipynb`

### Register BigBrain to MNI152 Space

Bring BigBrain histological data to MNI152 space for translation to structural MRI. For this purpose, we apply existing transforms generated by Xiao et al., 2019 and aggregated in BigBrainWarp (Paquola et al., 2021)
