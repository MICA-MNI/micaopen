# Functional analysis workflow

This repository contains scripts and instructions to register amygdala masks defined in each participant's native quantitative T1 space to functional space and performing functional connectivity and contextualization analyses described in our manuscript.

## Prerequisites

- Amygdala masks defined in qT1 space (from structural module)
- 7-functional network parcellation (Yeo et al. 2011) in standard surface template (e.g. fs-LR 32k, available [here](https://github.com/ThomasYeoLab/CBIG)) 
- Required software: Python v3.7 (see below for necessary packages), micapipe v0.2.3.

## Steps

### Register amygdala masks to functional space and extract timeseries

1. **Generate mean fMRI volume**: Average fMRI volume over time for each participant and save output. Note that all functional timeseries were already processed with micapipe v.0.2.3. 
2. **Register the amygdala masks and U1 map to functional space**: Register the amygdala masks generated in qT1 space to functional space. Co-registrations generated by micapipe can be applied for this purpose.
3. **Extract timeseries**: Extract the timeseries of each voxel in the newly registered amygdala mask in functional space.

### Additional pre-processing

4. **Spike regression**: Using a simple linear regression, we retain the residuals of a model removing the effet of motion spikes (outliers) in the timeseries data. 

- **Input:** 
  - Isolated amygdala timeseries
- **Output:** 
  - Cleaned amygdala timeseries

**Script:** `4.rsfmri_spike_regression.ipynb`

### Extract top and bottom 25% of U1 and U2 values

5. **Definition of regions of interest:** We extract the timeseries of voxels located in the top 25% and bottom 25% of U1 values and average across voxels in each region. A linear model accounting for age and sex and subject ID compared cortical functional connectivity profiles of each subregion.

- **Input:** 
  - Amygdala timeseries
- **Output:** 
  - Cortical functional connectivity profile of each amygdala subregion
  - T-statistic map and statistically significant regions after multiple comparisons correction. 
  
**Script:** `5.rsfmri_cortical_corr.ipynb`

### Contextualize functional findings

6. **Contextualize the functional connectivity patterns:** Once cortical connectivity maps are generated, we averaged all correlations coefficients within each of the 7 functional networks and plot the differences between networks. This procedure was repeated for each amygdala subregion as well as the whole amygdala. 

- **Input:** 
  - Amygdala cortical connectivity profiles
  - Functional network parcellations (Yeo et al. 2011)
- **Output:** 
  - Average connectivity to each functional community (radar plot)
  
**Script:** `6.rsfmri_cortical_corr_yeo7.ipynb`

### Meta-analytical decoding 

7. **Meta-analytical decoding using NeuroSynth:** We used [NeuroSynth](https://neurosynth.org/) activation map data aggregated in BrainStat (Larivi√®re et al., 2023) to identify cognitive terms associated with conenctivity profiles of the entire amygdala, the top 25% U1 subregion, the bottom 25% U1 subregion as well as the T-statistic map contrasting both U1 subregions. The results are plotted in table form and in a radar chart.

- **Input:** 
  - Amygdala cortical connectivity profiles
  - U1 subregion contrast map (T-statistic map)
- **Output:** 
  - List of terms from meta analysis (.csv)
  
**Script:** `7.rsfmri_cortical_corr_meta_analysis.ipynb`
